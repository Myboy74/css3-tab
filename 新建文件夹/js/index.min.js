var preLoad = false;
var imgArr = ['img/top.png', 'img/bottom.png', 'img/bgm-btn.svg'];
var printing = false;
var type = 1;
var index = 1;
var y0 = 0;
var y1 = 0;
var timeFunc = null;
var isFirst = false;
var isEnd = false;

function tongji() {
    var object_for_bi = document.getElementById("added_object_for_bi");
    object_for_bi.click()
};
document.addEventListener("WeixinJSBridgeReady", function () {
    wxShare(WEIXINSHARE.title, WEIXINSHARE.url, WEIXINSHARE.img, WEIXINSHARE.description, WEIXINSHARE.shareFunc)
}, false);
$(function () {
    function addBi() {
        var object_for_bi = document.getElementById("added_object_for_bi");
        if (object_for_bi) {
            object_for_bi.value = "hdpic";
            object_for_bi.click()
        }
    };
    addBi();
    var fontNum = $('html').css('font-size').split('px')[0];
    var contentHeight = $('html').height() - fontNum * (2.683 + 1.95);
    var oldHeight = fontNum * 17.95;

    function loadComplete() {
        $('.page2').fadeIn(500, function () {
            $('.page1').fadeOut();
            $('.page2-shineLight').addClass('alphaChange')
        })
    };
    loadimg(imgArr, loadComplete);
    var myAudio = document.getElementById('music');
    $('.landscape-hinter, .page1, .page2, .page3').on('touchmove', function (e) {
        e.preventDefault()
    });
    $('.dataDes-img').on('touchmove', function (e) {
        e.stopPropagation()
    });
    $('.print-out').on('touchstart', '.paper', function (e) {
        y0 = e.originalEvent.changedTouches[0].pageY
    });
    $('.print-out').on('touchend', '.paper', function (e) {
        if (printing) return;
        y1 = e.originalEvent.changedTouches[0].pageY;
        if (y1 > y0 + 50) {
            changeData();
            print()
        }
        if (y1 < y0 - 50) back()
    });
    $('.page2-enter').one('click', function (e) {
        myAudio.addEventListener('canplay', playBgMusic);
        myAudio.load();
        myAudio.play();
        $('.page3').fadeIn(500, function () {
            $('.page2').fadeOut();
            loadPage(1000)
        })
    });

    function playBgMusic(e) {
        myAudio.removeEventListener('canplay', playBgMusic);
        myAudio.play();
        $('.music').addClass('rotate')
    };
    $('.nextBtn').click(function (e) {
        if (printing) return;
        changeData();
        print()
    });
    $('.rePlay').on('click', function () {
        clear();
        location.hash = '#rpl' + '1';
        window.history.pushState(null, document.title, '#rpl' + '1');
        tongji();
        type = 1;
        index = 1;
        print();
        $('.resFooter,.resFooterBtn').animate({
            bottom: '-2.667rem'
        }, 800, function () {
            $('.resFooter,.resFooterBtn').hide();
            $('.footer,.footerBg').show();
            $('.footer,.footerBg').animate({
                bottom: '0rem'
            }, 800);
            timeFunc = setTimeout(function () {
                nextBtnShow();
                $('.resFooterBtn').hide()
            }, 800)
        })
    });
    $('.toShare').on('touchstart', function (e) {
        $('body,html,.page5').animate({
            scrollTop: 0
        }, 10);
        $('.guideShare').fadeIn()
    });
    $('.guideShare').on('touchstart', function (e) {
        $('.guideShare').fadeOut()
    });
    $('.footer').on('click', 'div', function () {
        if (printing) return;
        var idx = $(this).index();
        if (type == idx + 1) return;
        clear();
        type = idx + 1;
        index = 1;
        print()
    });

    function print() {
        if (timeFunc != null) {
            clearTimeout(timeFunc);
            timeFunc = null
        }
        if (type != 4 || index != 7) {
            isEnd = false
        } else {
            isEnd = true
        }
        printing = true;
        $("#p" + type + index).animate({
            'top': '0'
        }, 1000, function () {
            printing = false;
            var ftBtnClass = 'ftBtn' + type;
            $(".footer").removeClass().addClass('footer ' + ftBtnClass);
            if (index == 1) {
                var idx = type - 1
            }
        })
    };

    function back() {
        if (index == 1) return;
        if (type == 4 && index == 7) return;
        if (type != 1 || index != 1) {
            isFirst = false
        } else {
            isFirst = true
        }
        printing = true;
        $("#p" + type + index).animate({
            "top": "-17.95rem"
        }, 1000, function () {
            printing = false
        });
        index--
    };

    function changeData() {
        switch (type) {
            case 1:
                if (index == 4) {
                    clear();
                    type = 2;
                    index = 1
                } else {
                    index++
                }
                break;
            case 2:
                if (index == 2) {
                    clear();
                    type = 3;
                    index = 1
                } else {
                    index++
                }
                break;
            case 3:
                if (index == 3) {
                    clear();
                    type = 4;
                    index = 1
                } else {
                    index++
                }
                break;
            case 4:
                if (index == 6) {
                    $('.footer,.footerBg').animate({
                        bottom: '-2.683rem'
                    }, 800, function () {
                        $('.footer,.footerBg').hide();
                        $('.nextBtn').animate({
                            right: '-1.983rem'
                        });
                        $('.resFooter,.resFooterBtn').show().animate({
                            bottom: '0rem'
                        }, 800, function () {
                            $('.nextBtn').hide().css({
                                right: '0rem'
                            });
                            $('.resFooterBtn').show()
                        })
                    })
                }
                if (index != 7) {
                    index++
                }
                break
        }
    };

    function clear() {
        for (var i = 1; i <= index; i++) {
            $("#p" + type + i).animate({
                "top": $(window).height()
            }, function () {
                $(this).css('top', "-17.95rem")
            })
        }
    };

    function loadPage(num) {
        $('.header,.headerCover').show().animate({
            top: '0rem'
        }, 800, function () {
            $('.footer,.footerBg').hide().css({
                bottom: '-2.683rem'
            }).show().animate({
                bottom: '0rem'
            }, 800)
        });
        timeFunc = setTimeout(function () {
            print();
            nextBtnShow(num)
        }, 800);
        var winW = $(window).width();
        var winH = $(window).height();
        var ratio = winH / winW;
        if (ratio < (1334 / 750) || winW <= 320 || oldHeight - contentHeight > 11) {
            var bl = 1077 / 670;
            var newBgs = contentHeight / bl.toFixed(2) + 'px ' + contentHeight.toFixed(2) + 'px';
            $("#p11,#p12,#p13,#p14,#p21,#p22,#p31,#p32,#p33,#p41,#p42,#p43,#p44,#p45,#p46,#p47").css('background-size', newBgs);
            var mt = contentHeight.toFixed(2) * 0.34;
            $('.dataDes-scroll').height(contentHeight.toFixed(2) * (770 / 1077)).width(contentHeight.toFixed(2) * (670 / 1077)).css({
                marginTop: mt + 'px'
            });
            $('.dataDes-img').height(contentHeight.toFixed(2) * (1588 / 1077)).width(contentHeight.toFixed(2) * (670 / 1077))
        }
    };

    function nextBtnShow(num) {
        if ($('.nextBtn').css('right') == "0px" || $('.nextBtn').css('right') == "0rem") {
            $('.nextBtn').css('right', '-1.983rem')
        }
        if (num) {
            $('.nextBtn').show().animate({
                right: '0rem'
            }, 1000)
        } else {
            $('.nextBtn').show().animate({
                right: '0rem'
            }, 300)
        }
    };
    $('.music').click(function (e) {
        if (!myAudio.paused) {
            myAudio.pause();
            $('.music').removeClass('rotate')
        } else {
            myAudio.play();
            $('.music').addClass('rotate')
        }
    });
    window.onbeforeunload = function () {
        if (!myAudio.paused) {
            myAudio.pause();
            $('.music').removeClass('rotate')
        }
    };
    document.addEventListener("visibilitychange", function () {
        if (document.hidden) {
            if (!myAudio.paused) {
                myAudio.pause();
                $('.music').removeClass('rotate')
            }
        }
    })
});

function loadimg(imgs, callback) {
    if (!imgs) return false;
    var img = [];
    var len = imgs.length;
    var loadedCount = 0;
    for (var i = 0; i < len; i++) {
        img[i] = new Image();
        img[i].src = imgs[i];
        img[i].onload = function () {
            loadedCount++;
            document.getElementById('page1-tips-progress').innerHTML = Math.ceil(loadedCount / len * 100) + " %";
            if (loadedCount >= len) {
                preLoad = true;
                document.getElementById('page1-tips-progress').innerHTML = '100 %';
                setTimeout(function () {
                    callback ? callback() : null
                }, 500)
            }
        }
    }
};

function setin(callback) {
    var len = imgArr.length;
    var loadedCount = 0;
    this.percent = 0;
    interval = setInterval(function () {
        this.percent += 9;
        if (this.percent >= 99) {
            this.percent = 99;
            if (preLoad) {
                document.getElementById('page1-tips-progress').innerHTML = '100 %';
                setTimeout(function () {
                    callback ? callback() : null
                }, 500);
                clearInterval(this.interval)
            } else {
                document.getElementById('page1-tips-progress').innerHTML = this.percent + ' %'
            }
        } else {
            document.getElementById('page1-tips-progress').innerHTML = this.percent + ' %'
        }
    }, 400)
};